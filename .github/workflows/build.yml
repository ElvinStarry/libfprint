name: Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            meson \
            ninja-build \
            pkg-config \
            gtk-doc-tools \
            gobject-introspection \
            libgirepository1.0-dev \
            libglib2.0-dev \
            libgusb-dev \
            libgudev-1.0-dev \
            libgtk-3-dev \
            libcairo2-dev \
            libpixman-1-dev \
            libssl-dev \
            libusb-1.0-0-dev \
            python3-cairo \
            python3-gi

      - name: Configure build
        run: |
          meson setup build \
            --werror \
            -Dgtk-examples=true \
            -Ddrivers=all

      - name: Compile
        run: meson compile -C build

      - name: Create artifact
        run: |
          mkdir -p artifacts
          tar -C build -czf artifacts/libfprint-build.tar.gz \
            libfprint \
            examples \
            demo

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libfprint-build
          path: artifacts/libfprint-build.tar.gz
          if-no-files-found: error
